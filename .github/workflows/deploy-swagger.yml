name: Deploy Swagger to API Gateway

on:
  push:
    branches: [main]
    paths:
      - 'api/openapi.yaml'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test

  deploy-swagger:
    name: Upload Swagger to S3 and import to API Gateway
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get stack outputs
        id: stacks
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name StorageStack \
            --query "Stacks[0].Outputs[?OutputKey=='BucketName'].OutputValue" \
            --output text)

          API_ID=$(aws cloudformation describe-stacks \
            --stack-name ApiStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiId'].OutputValue" \
            --output text)

          LAMBDA_ARN=$(aws lambda get-function \
            --function-name "$(aws cloudformation describe-stacks \
              --stack-name ApiStack \
              --query "Stacks[0].Outputs[?OutputKey=='LambdaFunctionName'].OutputValue" \
              --output text)" \
            --query "Configuration.FunctionArn" \
            --output text)

          echo "bucket_name=$BUCKET_NAME" >> "$GITHUB_OUTPUT"
          echo "api_id=$API_ID" >> "$GITHUB_OUTPUT"
          echo "lambda_arn=$LAMBDA_ARN" >> "$GITHUB_OUTPUT"

      - name: Substitute Lambda ARN in spec
        run: |
          sed "s|\${CreateItemFunctionArn}|${{ steps.stacks.outputs.lambda_arn }}|g" \
            api/openapi.yaml > /tmp/openapi-resolved.yaml

      - name: Upload Swagger spec to S3
        run: |
          aws s3 cp /tmp/openapi-resolved.yaml \
            "s3://${{ steps.stacks.outputs.bucket_name }}/api-specs/openapi.yaml" \
            --content-type "application/x-yaml"

      - name: Import Swagger from S3 into API Gateway
        run: |
          node scripts/import-swagger-from-s3.mjs \
            "${{ steps.stacks.outputs.bucket_name }}" \
            "api-specs/openapi.yaml" \
            "${{ steps.stacks.outputs.api_id }}"

      - name: Deploy API Gateway
        run: |
          aws apigateway create-deployment \
            --rest-api-id "${{ steps.stacks.outputs.api_id }}" \
            --stage-name v1

      - name: Smoke test
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ApiStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
            --output text)

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${API_URL}items" \
            -H "Content-Type: application/json" \
            -d '{"name": "CI smoke test"}')

          if [ "$RESPONSE" != "201" ]; then
            echo "Smoke test failed â€” expected 201, got $RESPONSE"
            exit 1
          fi

          echo "Smoke test passed (HTTP $RESPONSE)"
